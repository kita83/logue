{% extends 'base_nav.html' %}
{% load static %}
{% block title %}Episode Detail{% endblock %}

{% block content %}
{% static "" as STATIC_URL %}
<script>
function updateButton(btn, is_active) {
  if (is_active) {
      btn.removeClass('btn-default').addClass('is-active')
      btn.html('<i class="fa fa-heart"></i> Liked')
  } else {
      btn.removeClass('is-active').addClass('btn-default')
      btn.html('<i class="fa fa-heart"></i> Like')
  }
};
function updateSubButton(btn, is_active) {
  if (is_active) {
      btn.removeClass('btn-default').addClass('is-active')
      btn.html('<i class="fa fa-plus-square"></i> Following')
  } else {
      btn.removeClass('is-active').addClass('btn-default')
      btn.html('<i class="fa fa-plus-square"></i> Follow')
  }
};
$(function() {
    $('#like').on('click', function() {
        var this_ = $(this)
        $.ajax({
            'url':'{% url "feed:change_like" %}',
            'type':'GET',
            'data':{
                'ep_id':this_.attr('data-episode-id'),
            },
            'dataType':'json'
        })
        .done(function(data){
            updateButton(this_, data.liked)
        })
        .fail(function(data){
          $('#error').attr('class', 'alert alert-danger alert-dismissable')
            $('#error').html('<button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>' + '登録できませんでした')
        })
    });
});
$(function() {
    $('#subscription').on('click', function() {
        var this_ = $(this)
        $.ajax({
            'url':'{% url "feed:change_subscription" %}',
            'type':'GET',
            'data':{
                'ch_id':this_.attr('data-channel-id'),
            },
            'dataType':'json'
        })
        .done(function(data){
            updateSubButton(this_, data.subscription)
        })
        .fail(function(data){
            $('#error').attr('class', 'alert alert-danger alert-dismissable')
            $('#error').html('<button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>' + '登録できませんでした')
        })
    });
});
</script>
<div id="page-wrapper">
  <div class="row">
    <div id="error"></div>
    <div class="ep-header clearfix">
      <div class="channel col-lg-3">
        {% if episode.channel %}
          <div class="channel-img">
            <a href="{{ episode.channel.get_absolute_url }}"><img class="img-circle" src="{{ STATIC_URL }}{{ episode.channel.cover_image }}" width=140px/></a>
          </div>
          <a href="{{ episode.channel.get_absolute_url }}"><h4>{{ episode.channel.title|safe }}</h4></a>
          <p class="author">{{ episode.channel.author|safe }}</p>
          <div class="sub-action">
            {% if subscription %}
              <button type="button" id="subscription" data-channel-id="{{ episode.channel.id }}" class="btn is-active btn-xs"><i class="fa fa-plus-square"></i> Following</button>
            {% else %}
              <button type="button" id="subscription" data-channel-id="{{ episode.channel.id }}" class="btn btn-default btn-xs"><i class="fa fa-plus-square"></i> Follow</button>
            {% endif %}
          </div>
          <p class="description">{{ episode.channel.description|safe }}</p>
          <p class="link"><a href="{{ episode.channel.link }}"><i class="fa fa-external-link fa-fw"></i> Website</a></p>
        {% else %}
          <p>チャンネル情報が取得できませんでした</p>
        {% endif %}
      </div>
      <div class="col-lg-9">
        {% if episode %}
          <p class="ep-date"><i class="fa fa-clock-o fa-fw"></i>{{ episode.published_time }}</p>
          <h3>{{ episode.title|safe }}</h3>
          <audio controls>
            <source src="{{ episode.audio_url }}" type="audio/mp3">
          </audio>
          <div class="action">
            {% if like %}
              <button type="button" id="like" data-episode-id="{{ episode.id }}" class="btn is-active btn-xs"><i class="fa fa-heart"></i> Liked</button>
            {% else %}
              <button type="button" id="like" data-episode-id="{{ episode.id }}" class="btn btn-default btn-xs"><i class="fa fa-heart"></i> Like</button>
            {% endif %}
          </div>
          <!-- コレクション追加モーダル -->
          <div class="modal fade" id="addCollectionModal" tabindex="-1" role="dialog" aria-labelledby="addCollectionModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                  <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>                        
                    <h4 class="modal-title" id="modal-label">コレクションに追加</h4>
                  </div>
                  <div class="modal-body">
                      <form action="" name="add_collection" method="GET">
                          {% csrf_token %}
                          {{ add_collection_form }}
                      </form>
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary">Add</button>
                  </div>
                </div>
            </div>
          </div>
          <div id="like_error">
            {{ result }}
          </div>
      {% else %}
          <p>エピソード情報が取得できませんでした</p>
      {% endif %}
      </div>
    </div>
    <div class="ep-body">
      <div class="col-lg-12">
        {{ parsed_description|safe }}
      </div>
    </div>
  </div>
</div>
{% endblock %}
