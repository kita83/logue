{% extends 'base_nav.html' %}
{% load static %}
{% block title %}Channel Detail{% endblock %}

{% block content %}
{% static "" as STATIC_URL %}
<script>
function updateSubButton(btn, is_active) {
  if (is_active) {
      btn.removeClass('btn-default').addClass('is-active')
      btn.html('<i class="fa fa-plus-square"></i> Following')
  } else {
      btn.removeClass('is-active').addClass('btn-default')
      btn.html('<i class="fa fa-plus-square"></i> Follow')
  }
};
$(function() {
    $('#subscription').on('click', function() {
        var this_ = $(this)
        $.ajax({
            'url':'{% url "feed:change_subscription" %}',
            'type':'GET',
            'data':{
                'ch_id':this_.attr('data-channel-id'),
            },
            'dataType':'json'
        })
        .done(function(data){
            updateSubButton(this_, data.subscription)
        })
        .fail(function(data){
            $('#sub_error').html('<p>' + '登録できませんでした' +'</p>')
            $('#sub_error').css('color', 'red')
        })
    });
});
</script>
<div id="page-wrapper">
  <div class="row">
    <div class="col-lg-9">
      <button type="button" class="subscribe btn btn-lg center-block">購読する</button>
      {% if episodes %}
      <h4 class="page-h4-header">エピソード</h4>
      <ul class="chat">
        {% for episode in episodes %}
        <li class="left clearfix">
          <div class="header">
            <small><a href="" class="track-title">{{ episode.channel.title|safe }}</a></small>
            <small class="text-muted pull-right"><i class="fa fa-clock-o fa-fw"></i>{{ episode.published_time }}</small>
          </div>
          <p class="track-title"><a href="{% url 'feed:ep_detail' episode.id %}">{{ episode.title|safe }}</a></p>
          <audio src="{{ episode.audio_url }}" preload="auto"></audio>
        </li>
        {% endfor %}
      {% else %}
        <p>There are no episodes available.</p>
      {% endif %}
    </ul>
    </div>
    <div class="ch-info col-lg-3">
      {% if channel %}
        <div class="channel-img">
          <img class="img-circle" src="{{ STATIC_URL }}{{ channel.cover_image }}" width=180px/>
        </div>
        <h4>{{ channel.title|safe }}</h4>
        <p class="author">{{ channel.author|safe }}</p>
        <div class="sub-action">
            {% if subscription %}
              <button type="button" id="subscription" data-channel-id="{{ channel.id }}" class="btn is-active btn-xs"><i class="fa fa-plus-square"></i> Following</button>
            {% else %}
              <button type="button" id="subscription" data-channel-id="{{ channel.id }}" class="btn btn-default btn-xs"><i class="fa fa-plus-square"></i> Follow</button>
            {% endif %}
          </div>
          <div id="sub_error">
              {{ result }}
            </div>
          <p class="description">{{ channel.description|safe }}</p>
          <p class="link"><a href="{{ channel.link }}" target="_blank"><i class="fa fa-external-link fa-fw"></i> Website</a></p>
      {% else %}
        <p>チャンネル情報が取得できませんでした</p>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}
